services:
  ap:
    # ====================== CPU HARD LIMIT (OPTIONAL) ======================
    # Hard cgroup-level cap. Remove these lines to cancel the strict limit.
    # Set this to (host_nproc * 0.4). Examples:
    # - host nproc=64  -> cpus: "25.6"
    # - host nproc=96  -> cpus: "38.4"
    cpus: "22.4"
    # Alternatively, pin to a subset of cores (also hard cap style):
    # cpuset: "0-25"
    # ======================================================================

    build:
      context: .
      network: host
      args:
        http_proxy: "http://127.0.0.1:3128"
        https_proxy: "http://127.0.0.1:3128"
        no_proxy: "${no_proxy}"

        TORCH_VERSION: "2.8.0.dev20250506+cpu"
        PYTHON_VERSION: "3.11"

        # Optional: matches Dockerfile default (40). Keep/remove both OK.
        CPU_LIMIT_PERCENT: "40"

    image: ap-llama3-cpu:torch-2.8.0-dev20250506
    network_mode: host
    working_dir: /workspace
    shm_size: "8g"

    environment:
      http_proxy: "http://127.0.0.1:3128"
      https_proxy: "http://127.0.0.1:3128"
      no_proxy: "${no_proxy}"

      HF_HOME: /cache/huggingface
      TRANSFORMERS_CACHE: /cache/huggingface/transformers
      HF_HUB_DISABLE_TELEMETRY: "1"
      TOKENIZERS_PARALLELISM: "false"
      PYTHONUNBUFFERED: "1"

    volumes:
      - "${PWD}:/workspace:rw"
      - "${HOME}/models:/models:ro"
      - "${HOME}/.cache/ap_hf:/cache:rw"

    command: ["/bin/bash"]
