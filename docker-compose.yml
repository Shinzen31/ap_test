services:
  ap:
    build:
      context: .
      network: host
      args:
        # 代理：让 build 阶段 (apt/pip/git) 能走宿主机代理
        http_proxy: "http://127.0.0.1:3128"
        https_proxy: "http://127.0.0.1:3128"
        no_proxy: "${no_proxy}"

        # 对齐 README 指定的 torch nightly
        TORCH_WHL_URL: "https://download.pytorch.org/whl/nightly/cpu/torch-2.8.0.dev20250506%2Bcpu-cp311-cp311-linux_x86_64.whl"
        AUTOPARALLEL_REPO: "https://github.com/meta-pytorch/autoparallel.git"
        AUTOPARALLEL_REF: "main"

    image: ap-llama3-cpu:torch-2.8.0.dev20250506
    network_mode: host
    working_dir: /workspace
    shm_size: "8g"

    environment:
      # 代理：运行时也走代理（pip/git/可能的外部访问）
      http_proxy: "http://127.0.0.1:3128"
      https_proxy: "http://127.0.0.1:3128"
      no_proxy: "${no_proxy}"

      HF_HOME: /cache/huggingface
      TRANSFORMERS_CACHE: /cache/huggingface/transformers
      HF_HUB_DISABLE_TELEMETRY: "1"
      TOKENIZERS_PARALLELISM: "false"
      PYTHONUNBUFFERED: "1"

    volumes:
      - "${PWD}:/workspace:rw"
      - "${HOME}/models:/models:ro"
      - "${HOME}/.cache/ap_hf:/cache:rw"

    command: ["/bin/bash"]
